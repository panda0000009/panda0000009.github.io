{"title":"","uid":"f73a8e23e6f6f669cf99c7dba8fa0722","slug":"with","date":"2025-07-22T08:28:13.043Z","updated":"2025-07-22T08:54:03.522Z","comments":true,"path":"api/articles/with.json","keywords":null,"cover":null,"content":"<h1 id=\"Python-with-语句使用对比\"><a href=\"#Python-with-语句使用对比\" class=\"headerlink\" title=\"Python with 语句使用对比\"></a>Python <code>with</code> 语句使用对比</h1><p>本文展示了在各种常见场景下使用 Python 的 <code>with</code> 上下文管理器与不使用时的写法对比。<br>with 语句依赖于上下文管理器（实现了 <code>__enter__</code> 和 <code>__exit__</code> 的对象）<br>如果一个类没有实现 <code>__enter__</code> 和 <code>__exit__</code>，那么就用不了 with</p>\n<hr>\n<h2 id=\"1-文件操作\"><a href=\"#1-文件操作\" class=\"headerlink\" title=\"1. 文件操作\"></a>1. 文件操作</h2><h3 id=\"✅-使用-with\"><a href=\"#✅-使用-with\" class=\"headerlink\" title=\"✅ 使用 with\"></a>✅ 使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> <span class=\"built_in\">open</span>(<span class=\"string\">&#x27;example.txt&#x27;</span>, <span class=\"string\">&#x27;r&#x27;</span>) <span class=\"keyword\">as</span> file:</span><br><span class=\"line\">    content = file.read()</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚠️-不使用-with\"><a href=\"#⚠️-不使用-with\" class=\"headerlink\" title=\"⚠️ 不使用 with\"></a>⚠️ 不使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file = <span class=\"built_in\">open</span>(<span class=\"string\">&#x27;example.txt&#x27;</span>, <span class=\"string\">&#x27;r&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    content = file.read()</span><br><span class=\"line\"><span class=\"keyword\">finally</span>:</span><br><span class=\"line\">    file.close()</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"2-线程锁\"><a href=\"#2-线程锁\" class=\"headerlink\" title=\"2. 线程锁\"></a>2. 线程锁</h2><h3 id=\"✅-使用-with-1\"><a href=\"#✅-使用-with-1\" class=\"headerlink\" title=\"✅ 使用 with\"></a>✅ 使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"></span><br><span class=\"line\">lock = threading.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">with</span> lock:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Thread-safe section&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚠️-不使用-with-1\"><a href=\"#⚠️-不使用-with-1\" class=\"headerlink\" title=\"⚠️ 不使用 with\"></a>⚠️ 不使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"></span><br><span class=\"line\">lock = threading.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\">lock.acquire()</span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Thread-safe section&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">finally</span>:</span><br><span class=\"line\">    lock.release()</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"3-数据库连接（sqlite3）\"><a href=\"#3-数据库连接（sqlite3）\" class=\"headerlink\" title=\"3. 数据库连接（sqlite3）\"></a>3. 数据库连接（sqlite3）</h2><h3 id=\"✅-使用-with-2\"><a href=\"#✅-使用-with-2\" class=\"headerlink\" title=\"✅ 使用 with\"></a>✅ 使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sqlite3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">with</span> sqlite3.connect(<span class=\"string\">&#x27;test.db&#x27;</span>) <span class=\"keyword\">as</span> conn:</span><br><span class=\"line\">    cursor = conn.cursor()</span><br><span class=\"line\">    cursor.execute(<span class=\"string\">&quot;INSERT INTO users (name) VALUES (&#x27;Tom&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚠️-不使用-with-2\"><a href=\"#⚠️-不使用-with-2\" class=\"headerlink\" title=\"⚠️ 不使用 with\"></a>⚠️ 不使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sqlite3</span><br><span class=\"line\"></span><br><span class=\"line\">conn = sqlite3.connect(<span class=\"string\">&#x27;test.db&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    cursor = conn.cursor()</span><br><span class=\"line\">    cursor.execute(<span class=\"string\">&quot;INSERT INTO users (name) VALUES (&#x27;Tom&#x27;)&quot;</span>)</span><br><span class=\"line\">    conn.commit()</span><br><span class=\"line\"><span class=\"keyword\">except</span> Exception:</span><br><span class=\"line\">    conn.rollback()</span><br><span class=\"line\">    <span class=\"keyword\">raise</span></span><br><span class=\"line\"><span class=\"keyword\">finally</span>:</span><br><span class=\"line\">    conn.close()</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"4-Socket-网络连接\"><a href=\"#4-Socket-网络连接\" class=\"headerlink\" title=\"4. Socket 网络连接\"></a>4. Socket 网络连接</h2><h3 id=\"✅-使用-with-3\"><a href=\"#✅-使用-with-3\" class=\"headerlink\" title=\"✅ 使用 with\"></a>✅ 使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">with</span> socket.create_connection((<span class=\"string\">&#x27;example.com&#x27;</span>, <span class=\"number\">80</span>)) <span class=\"keyword\">as</span> s:</span><br><span class=\"line\">    s.sendall(<span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\nHost: example.com\\r\\n\\r\\n&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚠️-不使用-with-3\"><a href=\"#⚠️-不使用-with-3\" class=\"headerlink\" title=\"⚠️ 不使用 with\"></a>⚠️ 不使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"></span><br><span class=\"line\">s = socket.create_connection((<span class=\"string\">&#x27;example.com&#x27;</span>, <span class=\"number\">80</span>))</span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    s.sendall(<span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\nHost: example.com\\r\\n\\r\\n&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">finally</span>:</span><br><span class=\"line\">    s.close()</span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"5-自定义上下文管理器\"><a href=\"#5-自定义上下文管理器\" class=\"headerlink\" title=\"5. 自定义上下文管理器\"></a>5. 自定义上下文管理器</h2><h3 id=\"✅-使用-with-4\"><a href=\"#✅-使用-with-4\" class=\"headerlink\" title=\"✅ 使用 with\"></a>✅ 使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyContext</span>:</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__enter__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Start&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable language_\">self</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__exit__</span>(<span class=\"params\">self, exc_type, exc_val, exc_tb</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;End&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">with</span> MyContext():</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Doing something&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"⚠️-不使用-with-4\"><a href=\"#⚠️-不使用-with-4\" class=\"headerlink\" title=\"⚠️ 不使用 with\"></a>⚠️ 不使用 <code>with</code></h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyContext</span>:</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">start</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Start&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">end</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&quot;End&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">ctx = MyContext()</span><br><span class=\"line\">ctx.start()</span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;Doing something&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">finally</span>:</span><br><span class=\"line\">    ctx.end()</span><br></pre></td></tr></table></figure>\n","text":"Python with 语句使用对比本文展示了在各种常见场景下使用 Python 的 with 上下文管理器与不使用时的写法对比。with 语句依赖于上下文管理...","permalink":"/post/with","photos":[],"count_time":{"symbolsCount":"2k","symbolsTime":"2 mins."},"categories":[],"tags":[],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Python-with-%E8%AF%AD%E5%8F%A5%E4%BD%BF%E7%94%A8%E5%AF%B9%E6%AF%94\"><span class=\"toc-text\">Python with 语句使用对比</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">1. 文件操作</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9C%85-%E4%BD%BF%E7%94%A8-with\"><span class=\"toc-text\">✅ 使用 with</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E4%B8%8D%E4%BD%BF%E7%94%A8-with\"><span class=\"toc-text\">⚠️ 不使用 with</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E7%BA%BF%E7%A8%8B%E9%94%81\"><span class=\"toc-text\">2. 线程锁</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9C%85-%E4%BD%BF%E7%94%A8-with-1\"><span class=\"toc-text\">✅ 使用 with</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E4%B8%8D%E4%BD%BF%E7%94%A8-with-1\"><span class=\"toc-text\">⚠️ 不使用 with</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%EF%BC%88sqlite3%EF%BC%89\"><span class=\"toc-text\">3. 数据库连接（sqlite3）</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9C%85-%E4%BD%BF%E7%94%A8-with-2\"><span class=\"toc-text\">✅ 使用 with</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E4%B8%8D%E4%BD%BF%E7%94%A8-with-2\"><span class=\"toc-text\">⚠️ 不使用 with</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-Socket-%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5\"><span class=\"toc-text\">4. Socket 网络连接</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9C%85-%E4%BD%BF%E7%94%A8-with-3\"><span class=\"toc-text\">✅ 使用 with</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E4%B8%8D%E4%BD%BF%E7%94%A8-with-3\"><span class=\"toc-text\">⚠️ 不使用 with</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8\"><span class=\"toc-text\">5. 自定义上下文管理器</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9C%85-%E4%BD%BF%E7%94%A8-with-4\"><span class=\"toc-text\">✅ 使用 with</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E4%B8%8D%E4%BD%BF%E7%94%A8-with-4\"><span class=\"toc-text\">⚠️ 不使用 with</span></a></li></ol></li></ol></li></ol>","author":{"name":"小郑","slug":"blog-author","avatar":"https://youke1.picui.cn/s1/2025/07/22/687f349caec39.png","link":"/","description":"<div>哈哈哈，活着真好</div>","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"","uid":"f73a8e23e6f6f669cf99c7dba8fa0722","slug":"2.进程-线程","date":"2025-07-22T08:37:37.102Z","updated":"2025-07-22T08:38:01.049Z","comments":true,"path":"api/articles/2.进程-线程.json","keywords":null,"cover":null,"text":"主要参考https://pythondjango.cn/python/advanced/2-python-multi-threads-multiprocessi...","permalink":"/post/2.进程-线程","photos":[],"count_time":{"symbolsCount":84,"symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"小郑","slug":"blog-author","avatar":"https://youke1.picui.cn/s1/2025/07/22/687f349caec39.png","link":"/","description":"<div>哈哈哈，活着真好</div>","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"","uid":"f73a8e23e6f6f669cf99c7dba8fa0722","slug":"1.进程-线程-协程-事件循环","date":"2025-07-22T08:15:17.352Z","updated":"2025-07-22T08:37:09.858Z","comments":true,"path":"api/articles/1.进程-线程-协程-事件循环.json","keywords":null,"cover":null,"text":"进程、线程、协程与事件循环 0. 基本概念 进程（Process） 子进程（Process） 多进程（Multiprocessing） 主进程（Main pro...","permalink":"/post/1.进程-线程-协程-事件循环","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"小郑","slug":"blog-author","avatar":"https://youke1.picui.cn/s1/2025/07/22/687f349caec39.png","link":"/","description":"<div>哈哈哈，活着真好</div>","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}